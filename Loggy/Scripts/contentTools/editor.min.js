(function(){var n,t={}.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n},r=[].slice;n=function(n){function t(){t.__super__.constructor.call(this);this.history=null;this._state="dormant";this._busy=!1;this._namingProp=null;this._fixtureTest=function(n){return n.hasAttribute("data-fixture")};this._regionQuery=null;this._domRegions=null;this._regions={};this._orderedRegions=[];this._rootLastModified=null;this._regionsLastModified={};this._ignition=null;this._inspector=null;this._toolbox=null;this._emptyRegionsAllowed=!1}return i(t,n),t.prototype.ctrlDown=function(){return this._ctrlDown},t.prototype.domRegions=function(){return this._domRegions},t.prototype.getState=function(){return this._state},t.prototype.ignition=function(){return this._ignition},t.prototype.inspector=function(){return this._inspector},t.prototype.isDormant=function(){return this._state==="dormant"},t.prototype.isReady=function(){return this._state==="ready"},t.prototype.isEditing=function(){return this._state==="editing"},t.prototype.orderedRegions=function(){var n;return function(){var t,u,i,r;for(i=this._orderedRegions,r=[],t=0,u=i.length;t<u;t++)n=i[t],r.push(this._regions[n]);return r}.call(this)},t.prototype.regions=function(){return this._regions},t.prototype.shiftDown=function(){return this._shiftDown},t.prototype.toolbox=function(){return this._toolbox},t.prototype.busy=function(n){return n===void 0&&(this._busy=n),this._busy=n,this._ignition?this._ignition.busy(n):void 0},t.prototype.createPlaceholderElement=function(){return new ContentEdit.Text("p",{},"")},t.prototype.init=function(n,t,i,r){return t==null&&(t="id"),i==null&&(i=null),r==null&&(r=!0),this._namingProp=t,i&&(this._fixtureTest=i),this.mount(),r&&(this._ignition=new ContentTools.IgnitionUI,this.attach(this._ignition),this._ignition.addEventListener("edit",function(n){return function(t){return t.preventDefault(),n.start(),n._ignition.state("editing")}}(this)),this._ignition.addEventListener("confirm",function(n){return function(t){if(t.preventDefault(),n._ignition.state()==="editing")return n._ignition.state("ready"),n.stop(!0)}}(this)),this._ignition.addEventListener("cancel",function(n){return function(t){if(t.preventDefault(),n._ignition.state()==="editing")return n.stop(!1),n.isEditing()?n._ignition.state("editing"):n._ignition.state("ready")}}(this))),this._toolbox=new ContentTools.ToolboxUI(ContentTools.DEFAULT_TOOLS),this.attach(this._toolbox),this._inspector=new ContentTools.InspectorUI,this.attach(this._inspector),this._state="ready",this._handleDetach=function(n){return function(){return n._preventEmptyRegions()}}(this),this._handleClipboardPaste=function(n){return function(t,i){var r;return r=null,i.clipboardData&&(r=i.clipboardData.getData("text/plain")),window.clipboardData&&(r=window.clipboardData.getData("TEXT")),n.paste(t,r)}}(this),this._handleNextRegionTransition=function(n){return function(t){var f,i,e,r,u,s,o;if(r=n.orderedRegions(),e=r.indexOf(t),!(e>=r.length-1)){for(t=r[e+1],i=null,o=t.descendants(),u=0,s=o.length;u<s;u++)if(f=o[u],f.content!==void 0){i=f;break}if(i){i.focus();i.selection(new ContentSelect.Range(0,0));return}return ContentEdit.Root.get().trigger("next-region",t)}}}(this),this._handlePreviousRegionTransition=function(n){return function(t){var f,r,i,e,o,s,u,h;if(s=n.orderedRegions(),e=s.indexOf(t),!(e<=0)){for(t=s[e-1],i=null,r=t.descendants(),r.reverse(),u=0,h=r.length;u<h;u++)if(f=r[u],f.content!==void 0){i=f;break}if(i){o=i.content.length();i.focus();i.selection(new ContentSelect.Range(o,o));return}return ContentEdit.Root.get().trigger("previous-region",t)}}}(this),ContentEdit.Root.get().bind("detach",this._handleDetach),ContentEdit.Root.get().bind("paste",this._handleClipboardPaste),ContentEdit.Root.get().bind("next-region",this._handleNextRegionTransition),ContentEdit.Root.get().bind("previous-region",this._handlePreviousRegionTransition),this.syncRegions(n)},t.prototype.destroy=function(){return ContentEdit.Root.get().unbind("detach",this._handleDetach),ContentEdit.Root.get().unbind("paste",this._handleClipboardPaste),ContentEdit.Root.get().unbind("next-region",this._handleNextRegionTransition),ContentEdit.Root.get().unbind("previous-region",this._handlePreviousRegionTransition),this.unmount()},t.prototype.highlightRegions=function(n){var r,t,f,u,i;for(u=this._domRegions,i=[],t=0,f=u.length;t<f;t++)r=u[t],n?i.push(ContentEdit.addCSSClass(r,"ct--highlight")):i.push(ContentEdit.removeCSSClass(r,"ct--highlight"));return i},t.prototype.mount=function(){return this._domElement=this.constructor.createDiv(["ct-app"]),document.body.insertBefore(this._domElement,null),this._addDOMEventListeners()},t.prototype.paste=function(n,t){var p,i,w,b,v,k,o,f,s,d,h,c,g,e,nt,u,l,y,it,rt,a,tt,ut;if(i=t,e=i.split("\n"),e=e.filter(function(n){return n.trim()!==""}),e){if(b=HTMLString.String.encode,l=!0,a=n.type(),e.length===1&&(l=!1),a==="PreText"&&(l=!1),n.can("spawn")||(l=!1),l){for(a==="ListItemText"?(f=n.parent(),o=n.parent().parent(),k=o.children.indexOf(f)+1):(f=n,f.parent().type()!=="Region"&&(f=n.closest(function(n){return n.parent().type()==="Region"})),o=f.parent(),k=o.children.indexOf(f)+1),v=tt=0,ut=e.length;tt<ut;v=++tt)c=e[v],c=b(c),a==="ListItemText"?(s=new ContentEdit.ListItem,d=new ContentEdit.ListItemText(c),s.attach(d),h=d):(s=new ContentEdit.Text("p",{},c),h=s),o.attach(s,k+v);return g=h.content.length(),h.focus(),h.selection(new ContentSelect.Range(g,g))}return i=b(i),i=new HTMLString.String(i,a==="PreText"),u=n.selection(),w=u.get()[0]+i.length(),rt=n.content.substring(0,u.get()[0]),it=n.content.substring(u.get()[1]),nt=n.content.substring(u.get()[0],u.get()[1]),nt.length()&&(p=nt.characters[0],y=p.tags(),p.isTag()&&y.shift(),y.length>=1&&(i=i.format.apply(i,[0,i.length()].concat(r.call(y))))),n.content=rt.concat(i),n.content=n.content.concat(it,!1),n.updateInnerHTML(),n.taint(),u.set(w,w),n.selection(u)}},t.prototype.unmount=function(){if(this.isMounted())return this._domElement.parentNode.removeChild(this._domElement),this._domElement=null,this._removeDOMEventListeners(),this._ignition=null,this._inspector=null,this._toolbox=null},t.prototype.revert=function(){var n;if(this.dispatchEvent(this.createEvent("revert")))return(n=ContentEdit._("Your changes have not been saved, do you really want to lose them?"),ContentEdit.Root.get().lastModified()>this._rootLastModified&&!window.confirm(n))?!1:(this.revertToSnapshot(this.history.goTo(0),!1),!0)},t.prototype.revertToSnapshot=function(n,t){var s,i,r,u,h,f,e,o;t==null&&(t=!0);f=this._regions;for(i in f){for(r=f[i],e=r.children,u=0,h=e.length;u<h;u++)s=e[u],s.unmount();r.domElement().innerHTML=n.regions[i]}if(t){ContentEdit.Root.get().focused()&&ContentEdit.Root.get().focused().blur();this._regions={};this.syncRegions(null,!0);ContentEdit.Root.get()._modified=n.rootModified;o=this._regions;for(i in o)r=o[i],n.regionModifieds[i]&&(r._modified=n.regionModifieds[i]);return this.history.replaceRegions(this._regions),this.history.restoreSelection(n),this._inspector.updateTags()}},t.prototype.save=function(n){var i,u,e,r,t,h,f,c,o,s;if(this.dispatchEvent(this.createEvent("save",{passive:n}))){if(h=ContentEdit.Root.get(),h.lastModified()===this._rootLastModified&&n){this.dispatchEvent(this.createEvent("saved",{regions:{},passive:n}));return}e={};o=this._regions;for(r in o){if(t=o[r],u=t.html(),t.children.length===1&&(i=t.children[0],i.content&&!i.content.html()&&(u="")),!n){for(s=t.children,f=0,c=s.length;f<c;f++)i=s[f],i.unmount();t.domElement().innerHTML=u}t.lastModified()!==this._regionsLastModified[r]&&(e[r]=u,this._regionsLastModified[r]=t.lastModified())}return this.dispatchEvent(this.createEvent("saved",{regions:e,passive:n}))}},t.prototype.setRegionOrder=function(n){return this._orderedRegions=n.slice()},t.prototype.start=function(){if(this.dispatchEvent(this.createEvent("start")))return this.busy(!0),this.syncRegions(),this._initRegions(),this._preventEmptyRegions(),this._rootLastModified=ContentEdit.Root.get().lastModified(),this.history=new ContentTools.History(this._regions),this.history.watch(),this._state="editing",this._toolbox.show(),this._inspector.show(),this.busy(!1)},t.prototype.stop=function(n){var t;if(this.dispatchEvent(this.createEvent("stop",{save:n}))){if(t=ContentEdit.Root.get().focused(),t&&t.isMounted()&&t._syncContent!==void 0&&t._syncContent(),n)this.save();else if(!this.revert())return;this.history.stopWatching();this.history=null;this._toolbox.hide();this._inspector.hide();this._regions={};this._state="ready";ContentEdit.Root.get().focused()&&this._allowEmptyRegions(function(){return function(){return ContentEdit.Root.get().focused().blur()}}(this))}},t.prototype.syncRegions=function(n,t){return n&&(this._regionQuery=n),this._domRegions=[],this._regionQuery&&(this._domRegions=typeof this._regionQuery=="string"||this._regionQuery instanceof String?document.querySelectorAll(this._regionQuery):this._regionQuery),this._state==="editing"&&(this._initRegions(t),this._preventEmptyRegions()),this._ignition?this._domRegions.length?this._ignition.show():this._ignition.hide():void 0},t.prototype._addDOMEventListeners=function(){return this._handleHighlightOn=function(n){return function(t){var i;if(((i=t.keyCode)===17||i===224||i===91||i===93)&&(n._ctrlDown=!0),t.keyCode===16&&!n._ctrlDown){if(n._highlightTimeout)return;n._shiftDown=!0;n._highlightTimeout=setTimeout(function(){return n.highlightRegions(!0)},ContentTools.HIGHLIGHT_HOLD_DURATION);return}return clearTimeout(n._highlightTimeout),n.highlightRegions(!1)}}(this),this._handleHighlightOff=function(n){return function(t){var i;if((i=t.keyCode)===17||i===224){n._ctrlDown=!1;return}if(t.keyCode===16)return n._shiftDown=!1,n._highlightTimeout&&(clearTimeout(n._highlightTimeout),n._highlightTimeout=null),n.highlightRegions(!1)}}(this),this._handleVisibility=function(n){return function(){if(!document.hasFocus())return clearTimeout(n._highlightTimeout),n.highlightRegions(!1)}}(this),document.addEventListener("keydown",this._handleHighlightOn),document.addEventListener("keyup",this._handleHighlightOff),document.addEventListener("visibilitychange",this._handleVisibility),this._handleBeforeUnload=function(n){return function(t){var i;if(n._state==="editing")return i=ContentEdit._(ContentTools.CANCEL_MESSAGE),(t||window.event).returnValue=i,i}}(this),window.addEventListener("beforeunload",this._handleBeforeUnload),this._handleUnload=function(n){return function(){return n.destroy()}}(this),window.addEventListener("unload",this._handleUnload)},t.prototype._allowEmptyRegions=function(n){return this._emptyRegionsAllowed=!0,n(),this._emptyRegionsAllowed=!1},t.prototype._preventEmptyRegions=function(){var e,i,o,s,h,n,t,c,r,u,f;if(!this._emptyRegionsAllowed){r=this._regions;f=[];for(s in r){for(n=r[s],o=n.lastModified(),i=!1,u=n.children,t=0,c=u.length;t<c;t++)if(e=u[t],e.type()!=="Static"){i=!0;break}i||(h=this.createPlaceholderElement(n),n.attach(h),f.push(n._modified=o))}return f}},t.prototype._removeDOMEventListeners=function(){return document.removeEventListener("keydown",this._handleHighlightOn),document.removeEventListener("keyup",this._handleHighlightOff),window.removeEventListener("beforeunload",this._handleBeforeUnload),window.removeEventListener("unload",this._handleUnload)},t.prototype._initRegions=function(n){var i,f,r,e,t,l,o,c,s,h,u;for(n==null&&(n=!1),f={},this._orderedRegions=[],s=this._domRegions,r=o=0,c=s.length;o<c;r=++o)(i=s[r],t=i.getAttribute(this._namingProp),t||(t=r),f[t]=!0,this._orderedRegions.push(t),this._regions[t]&&this._regions[t].domElement()===i)||(this._regions[t]=this._fixtureTest(i)?new ContentEdit.Fixture(i):new ContentEdit.Region(i),n||(this._regionsLastModified[t]=this._regions[t].lastModified()));h=this._regions;u=[];for(t in h)(l=h[t],f[t])||(delete this._regions[t],delete this._regionsLastModified[t],e=this._orderedRegions.indexOf(t),e>-1?u.push(this._orderedRegions.splice(e,1)):u.push(void 0));return u},t}(ContentTools.ComponentUI);ContentTools.EditorApp=function(){function i(){}var t;return t=null,i.get=function(){var n;return n=ContentTools.EditorApp.getCls(),t!=null?t:t=new n},i.getCls=function(){return n},i}()}).call(this);