(function(){ContentTools.History=function(){function n(n){this._lastSnapshotTaken=null;this._regions={};this.replaceRegions(n);this._snapshotIndex=-1;this._snapshots=[];this._store()}return n.prototype.canRedo=function(){return this._snapshotIndex<this._snapshots.length-1},n.prototype.canUndo=function(){return this._snapshotIndex>0},n.prototype.index=function(){return this._snapshotIndex},n.prototype.length=function(){return this._snapshots.length},n.prototype.snapshot=function(){return this._snapshots[this._snapshotIndex]},n.prototype.goTo=function(n){return this._snapshotIndex=Math.min(this._snapshots.length-1,Math.max(0,n)),this.snapshot()},n.prototype.redo=function(){return this.goTo(this._snapshotIndex+1)},n.prototype.replaceRegions=function(n){var t,r,i;this._regions={};i=[];for(t in n)r=n[t],i.push(this._regions[t]=r);return i},n.prototype.restoreSelection=function(n){var t,i;if(n.selected)return i=this._regions[n.selected.region],t=i.descendants()[n.selected.element],t.focus(),t.selection&&n.selected.selection?t.selection(n.selected.selection):void 0},n.prototype.stopWatching=function(){return this._watchInterval&&clearInterval(this._watchInterval),this._delayedStoreTimeout?clearTimeout(this._delayedStoreTimeout):void 0},n.prototype.undo=function(){return this.goTo(this._snapshotIndex-1)},n.prototype.watch=function(){var n;return this._lastSnapshotTaken=Date.now(),n=function(n){return function(){var i,t;if(t=ContentEdit.Root.get().lastModified(),t!==null)return t>n._lastSnapshotTaken?n._delayedStoreRequested===t?void 0:(n._delayedStoreTimeout&&clearTimeout(n._delayedStoreTimeout),i=function(){return n._lastSnapshotTaken=t,n._store()},n._delayedStoreRequested=t,n._delayedStoreTimeout=setTimeout(i,500)):void 0}}(this),this._watchInterval=setInterval(n,50)},n.prototype._store=function(){var r,t,e,i,n,u,f;n={regions:{},regionModifieds:{},rootModified:ContentEdit.Root.get().lastModified(),selected:null};u=this._regions;for(t in u)i=u[t],n.regions[t]=i.html(),n.regionModifieds[t]=i.lastModified();if(r=ContentEdit.Root.get().focused(),r){if(n.selected={},i=r.closest(function(n){return n.type()==="Region"||n.type()==="Fixture"}),!i)return;f=this._regions;for(t in f)if(e=f[t],i===e){n.selected.region=t;break}n.selected.element=i.descendants().indexOf(r);r.selection&&(n.selected.selection=r.selection())}return this._snapshotIndex<this._snapshots.length-1&&(this._snapshots=this._snapshots.slice(0,this._snapshotIndex+1)),this._snapshotIndex++,this._snapshots.splice(this._snapshotIndex,0,n)},n}()}).call(this);