(function(){var n,i={}.hasOwnProperty,t=function(n,t){function u(){this.constructor=n}for(var r in t)i.call(t,r)&&(n[r]=t[r]);return u.prototype=t.prototype,n.prototype=new u,n.__super__=t.prototype,n};ContentTools.ImageDialog=function(i){function r(){r.__super__.constructor.call(this,"Insert image");this._cropMarks=null;this._imageURL=null;this._imageSize=null;this._progress=0;this._state="empty";ContentTools.IMAGE_UPLOADER&&ContentTools.IMAGE_UPLOADER(this)}return t(r,i),r.prototype.cropRegion=function(){return this._cropMarks?this._cropMarks.region():[0,0,1,1]},r.prototype.addCropMarks=function(){if(!this._cropMarks)return this._cropMarks=new n(this._imageSize),this._cropMarks.mount(this._domView),ContentEdit.addCSSClass(this._domCrop,"ct-control--active")},r.prototype.clear=function(){return this._domImage&&(this._domImage.parentNode.removeChild(this._domImage),this._domImage=null),this._imageURL=null,this._imageSize=null,this.state("empty")},r.prototype.mount=function(){var n,i,t;return r.__super__.mount.call(this),ContentEdit.addCSSClass(this._domElement,"ct-image-dialog"),ContentEdit.addCSSClass(this._domElement,"ct-image-dialog--empty"),ContentEdit.addCSSClass(this._domView,"ct-image-dialog__view"),t=this.constructor.createDiv(["ct-control-group","ct-control-group--left"]),this._domControls.appendChild(t),this._domRotateCCW=this.constructor.createDiv(["ct-control","ct-control--icon","ct-control--rotate-ccw"]),this._domRotateCCW.setAttribute("data-ct-tooltip",ContentEdit._("Rotate")+" -90°"),t.appendChild(this._domRotateCCW),this._domRotateCW=this.constructor.createDiv(["ct-control","ct-control--icon","ct-control--rotate-cw"]),this._domRotateCW.setAttribute("data-ct-tooltip",ContentEdit._("Rotate")+" 90°"),t.appendChild(this._domRotateCW),this._domCrop=this.constructor.createDiv(["ct-control","ct-control--icon","ct-control--crop"]),this._domCrop.setAttribute("data-ct-tooltip",ContentEdit._("Crop marks")),t.appendChild(this._domCrop),i=this.constructor.createDiv(["ct-progress-bar"]),t.appendChild(i),this._domProgress=this.constructor.createDiv(["ct-progress-bar__progress"]),i.appendChild(this._domProgress),n=this.constructor.createDiv(["ct-control-group","ct-control-group--right"]),this._domControls.appendChild(n),this._domUpload=this.constructor.createDiv(["ct-control","ct-control--text","ct-control--upload"]),this._domUpload.textContent=ContentEdit._("Upload"),n.appendChild(this._domUpload),this._domInput=document.createElement("input"),this._domInput.setAttribute("class","ct-image-dialog__file-upload"),this._domInput.setAttribute("name","file"),this._domInput.setAttribute("type","file"),this._domInput.setAttribute("accept","image/*"),this._domUpload.appendChild(this._domInput),this._domInsert=this.constructor.createDiv(["ct-control","ct-control--text","ct-control--insert"]),this._domInsert.textContent=ContentEdit._("Insert"),n.appendChild(this._domInsert),this._domCancelUpload=this.constructor.createDiv(["ct-control","ct-control--text","ct-control--cancel"]),this._domCancelUpload.textContent=ContentEdit._("Cancel"),n.appendChild(this._domCancelUpload),this._domClear=this.constructor.createDiv(["ct-control","ct-control--text","ct-control--clear"]),this._domClear.textContent=ContentEdit._("Clear"),n.appendChild(this._domClear),this._addDOMEventListeners(),this.dispatchEvent(this.createEvent("imageuploader.mount"))},r.prototype.populate=function(n,t){return this._imageURL=n,this._imageSize=t,this._domImage||(this._domImage=this.constructor.createDiv(["ct-image-dialog__image"]),this._domView.appendChild(this._domImage)),this._domImage.style["background-image"]="url("+n+")",this.state("populated")},r.prototype.progress=function(n){return n===void 0?this._progress:(this._progress=n,!this.isMounted())?void 0:this._domProgress.style.width=""+this._progress+"%"},r.prototype.removeCropMarks=function(){if(this._cropMarks)return this._cropMarks.unmount(),this._cropMarks=null,ContentEdit.removeCSSClass(this._domCrop,"ct-control--active")},r.prototype.save=function(n,t,i){return this.dispatchEvent(this.createEvent("save",{imageURL:n,imageSize:t,imageAttrs:i}))},r.prototype.state=function(n){var t;return n===void 0?this._state:this._state===n?void 0:(t=this._state,this._state=n,!this.isMounted())?void 0:(ContentEdit.addCSSClass(this._domElement,"ct-image-dialog--"+this._state),ContentEdit.removeCSSClass(this._domElement,"ct-image-dialog--"+t))},r.prototype.unmount=function(){return r.__super__.unmount.call(this),this._domCancelUpload=null,this._domClear=null,this._domCrop=null,this._domInput=null,this._domInsert=null,this._domProgress=null,this._domRotateCCW=null,this._domRotateCW=null,this._domUpload=null,this.dispatchEvent(this.createEvent("imageuploader.unmount"))},r.prototype._addDOMEventListeners=function(){return r.__super__._addDOMEventListeners.call(this),this._domInput.addEventListener("change",function(n){return function(t){var i;return i=t.target.files[0],t.target.value="",t.target.value&&(t.target.type="text",t.target.type="file"),n.dispatchEvent(n.createEvent("imageuploader.fileready",{file:i}))}}(this)),this._domCancelUpload.addEventListener("click",function(n){return function(){return n.dispatchEvent(n.createEvent("imageuploader.cancelupload"))}}(this)),this._domClear.addEventListener("click",function(n){return function(){return n.removeCropMarks(),n.dispatchEvent(n.createEvent("imageuploader.clear"))}}(this)),this._domRotateCCW.addEventListener("click",function(n){return function(){return n.removeCropMarks(),n.dispatchEvent(n.createEvent("imageuploader.rotateccw"))}}(this)),this._domRotateCW.addEventListener("click",function(n){return function(){return n.removeCropMarks(),n.dispatchEvent(n.createEvent("imageuploader.rotatecw"))}}(this)),this._domCrop.addEventListener("click",function(n){return function(){return n._cropMarks?n.removeCropMarks():n.addCropMarks()}}(this)),this._domInsert.addEventListener("click",function(n){return function(){return n.dispatchEvent(n.createEvent("imageuploader.save"))}}(this))},r}(ContentTools.DialogUI);n=function(n){function i(n){i.__super__.constructor.call(this);this._bounds=null;this._dragging=null;this._draggingOrigin=null;this._imageSize=n}return t(i,n),i.prototype.mount=function(n,t){return t==null&&(t=null),this._domElement=this.constructor.createDiv(["ct-crop-marks"]),this._domClipper=this.constructor.createDiv(["ct-crop-marks__clipper"]),this._domElement.appendChild(this._domClipper),this._domRulers=[this.constructor.createDiv(["ct-crop-marks__ruler","ct-crop-marks__ruler--top-left"]),this.constructor.createDiv(["ct-crop-marks__ruler","ct-crop-marks__ruler--bottom-right"])],this._domClipper.appendChild(this._domRulers[0]),this._domClipper.appendChild(this._domRulers[1]),this._domHandles=[this.constructor.createDiv(["ct-crop-marks__handle","ct-crop-marks__handle--top-left"]),this.constructor.createDiv(["ct-crop-marks__handle","ct-crop-marks__handle--bottom-right"])],this._domElement.appendChild(this._domHandles[0]),this._domElement.appendChild(this._domHandles[1]),i.__super__.mount.call(this,n,t),this._fit(n)},i.prototype.region=function(){return[parseFloat(this._domHandles[0].style.top)/this._bounds[1],parseFloat(this._domHandles[0].style.left)/this._bounds[0],parseFloat(this._domHandles[1].style.top)/this._bounds[1],parseFloat(this._domHandles[1].style.left)/this._bounds[0]]},i.prototype.unmount=function(){return i.__super__.unmount.call(this),this._domClipper=null,this._domHandles=null,this._domRulers=null},i.prototype._addDOMEventListeners=function(){return i.__super__._addDOMEventListeners.call(this),this._domHandles[0].addEventListener("mousedown",function(n){return function(t){if(t.button===0)return n._startDrag(0,t.clientY,t.clientX)}}(this)),this._domHandles[1].addEventListener("mousedown",function(n){return function(t){if(t.button===0)return n._startDrag(1,t.clientY,t.clientX)}}(this))},i.prototype._drag=function(n,t){var f,i,r,u,e;if(this._dragging!==null)return ContentSelect.Range.unselectAll(),u=n-this._draggingOrigin[1],r=t-this._draggingOrigin[0],f=this._bounds[1],t=0,n=0,e=this._bounds[0],i=Math.min(Math.min(ContentTools.MIN_CROP,f),e),this._dragging===0?(f=parseInt(this._domHandles[1].style.top)-i,e=parseInt(this._domHandles[1].style.left)-i):(t=parseInt(this._domHandles[0].style.left)+i,n=parseInt(this._domHandles[0].style.top)+i),u=Math.min(Math.max(n,u),f),r=Math.min(Math.max(t,r),e),this._domHandles[this._dragging].style.top=""+u+"px",this._domHandles[this._dragging].style.left=""+r+"px",this._domRulers[this._dragging].style.top=""+u+"px",this._domRulers[this._dragging].style.left=""+r+"px"},i.prototype._fit=function(n){var t,f,e,u,r,o,i,s;return r=n.getBoundingClientRect(),s=r.width/this._imageSize[0],f=r.height/this._imageSize[1],u=Math.min(s,f),i=u*this._imageSize[0],t=u*this._imageSize[1],e=(r.width-i)/2,o=(r.height-t)/2,this._domElement.style.width=""+i+"px",this._domElement.style.height=""+t+"px",this._domElement.style.top=""+o+"px",this._domElement.style.left=""+e+"px",this._domHandles[0].style.top="0px",this._domHandles[0].style.left="0px",this._domHandles[1].style.top=""+t+"px",this._domHandles[1].style.left=""+i+"px",this._domRulers[0].style.top="0px",this._domRulers[0].style.left="0px",this._domRulers[1].style.top=""+t+"px",this._domRulers[1].style.left=""+i+"px",this._bounds=[i,t]},i.prototype._startDrag=function(n,t,i){var r;return r=this._domHandles[n],this._dragging=n,this._draggingOrigin=[i-parseInt(r.style.left),t-parseInt(r.style.top)],this._onMouseMove=function(n){return function(t){return n._drag(t.clientY,t.clientX)}}(this),document.addEventListener("mousemove",this._onMouseMove),this._onMouseUp=function(n){return function(){return n._stopDrag()}}(this),document.addEventListener("mouseup",this._onMouseUp)},i.prototype._stopDrag=function(){return document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._dragging=null,this._draggingOrigin=null},i}(ContentTools.AnchoredComponentUI)}).call(this);